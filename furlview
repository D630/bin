#!/usr/bin/env bash
#
# Simple replacement for urlview using fzf in X.

__x_web_browser () { setsidw x-web-browser "$1"; }

__fzf () { fzf --tac -e -i -m; }

__ugrep ()
{
        grep -oP -e \
                '((http|https|gopher|ftp|ftps|webdav|webdavs|dav|davs):(//)?[^ <>"\t]*|(www|ftp)[0-9]?\.[-a-z0-9.]+)[^ .,;\t\n\r<">\):]?[^, <>"\t]*[^ .,;\t\n\r<">\):]'
}

__select () { __ugrep | __fzf; }

if
        [[ -p /dev/stdin || -f /dev/stdin ]]
then
        mapfile -t furls < <(__select);
else
        if
                ! (($#))
        then
                printf '%s\n' "?" 1>&2;
                exit 1
        fi
        mapfile -t furls < <(
                for a
                do
                        if
                                [[ -p $a || -f $a ]]
                        then
                                cat "$a"
                        else
                                printf 'File %s does not exist or is neather a regular file nor a named pipe' "$a" 1>&2;
                                exit 1
                        fi
                done \
                | __select;
        )
fi

if
        ((${#furls[@]}))
then
        if
                [[ -n $DISPLAY ]]
        then
                for u in "${furls[@]}"
                do
                        __x_web_browser "$u" &
                done
        fi
        wait
fi

# vim: set ts=8 sw=8 tw=0 et :
