#!/usr/bin/env bash
#
# Log me in into rocketchat via REST.

read -e -s -r -p 'pw: ' pw;

auth_token_file=$HOME/.rocketchat_wir_invalid_auth_token;
user=D630.d630;

> "$auth_token_file";
chmod 640 "$auth_token_file";

auth_token=$(
	ROCKETCHAT_REST_TOKEN= \
	ROCKETCHAT_REST_USER_ID= \
	rocketchat-rest-api post \
		/api/v1/login \
		'{"user": "'"$user"'", "password": "'"${pw:?error: pw missing}"'"}' 2>/dev/null |
	jq -r .data.authToken;
);

[[ -n "$auth_token" && "$auth_token" != null ]] || {
	echo 'login failed' 1>&2;
	exit 1;
}

echo "$auth_token" | tee -a "$auth_token_file";
chmod 640 "$auth_token_file";

# vim: set ft=sh :
