#!/usr/bin/env bash
#
# Get mail and give notification + sound.

mpop >> "${XDG_VAR_HOME}/log/mbsync.log" 2>&1;
mbsync -V "${@:-posteo}" >> "${XDG_VAR_HOME}/log/mbsync.log" 2>&1;

mapfile -t newmails < <(
        find "${XDG_VAR_HOME}/mail/storage/dovecot/.${X_POSTEO1}".* -type f -path "*/new/*"
)

if
        (( ${#newmails[@]} ))
then
        if
                [[ -n $DISPLAY ]]
        then
                notify-send -u low -h int:value:42 \
                        "[Posteo] new Mails: ${#newmails[@]}";
        else
                printf '[Posteo] new Mails: %d\n' "${#newmails[@]}" 1>&2;
        fi
        aplay "${XDG_DATA_HOME}/sounds/mac-sound-pack-new-mail.wav" \
                1>/dev/null \
                2>&1;
else
        printf '[Posteo] new Mails: %d\n' "${#newmails[@]}" 1>&2;
fi

# vim: set ts=8 sw=8 tw=0 et :
